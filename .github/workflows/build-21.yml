name: Build OpenWrt (ZTE E8820V2)

on:
  # Izinkan run manual dari tab Actions
  workflow_dispatch:
  # Otomatis build jika ada push ke branch main
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üóëÔ∏è Cleanup Ruang Disk Runner
        run: |
          echo "Disk usage before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "Disk usage after cleanup:"
          df -h
    
      # 1. Checkout kode Anda
      - name: Checkout OpenWrt Source Branch
        uses: actions/checkout@v4
        with:
          repository: paralelunipers/sm-wrt
          ref: openwrt-21.02

      # 2. Install dependensi build yang diperlukan
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex gawk gettext \
            git g++ libelf-dev libncurses5-dev \
            libssl-dev python3 python3-venv \
            python3-pkg-resources python3-pyelftools \
            rsync subversion swig time unzip wget \
            zlib1g-dev file

      # 3. Update dan install feeds OpenWrt
      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. Salin file .config khusus (DIPERBARUI)
      - name: Load custom .config from user-config directory
        run: |
          # Menyalin file konfigurasi lengkap dari lokasi yang ditentukan ke .config
           CONFIG_URL="https://raw.githubusercontent.com/paralelunipers/sm-wrt/refs/heads/main/user-config/config-zte-e8820v2"
          wget -q --show-progress -O .config $CONFIG_URL

      # 5. Buat .config lengkap dan bersih (Wajib ada untuk mengatasi opsi NEW)
      - name: Generate full and clean .config
        run: |
          make defconfig

      # 6. Mulai proses build (ini akan lama)
      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      # 7. Ambil firmware yang sudah jadi
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware-zte-e8820v2
          # Ambil hanya file sysupgrade dan factory untuk device ini
          path: bin/targets/ramips/mt7621/*zte_e8820v2*
          if-no-files-found: error
