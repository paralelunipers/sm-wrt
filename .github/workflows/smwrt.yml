name: Build OpenWrt 24

on:
  # Izinkan run manual dari tab Actions
  workflow_dispatch:
  # Otomatis build jika ada push ke branch main
 
jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: üóëÔ∏è Cleanup Ruang Disk Runner
        run: |
          echo "Disk usage before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "Disk usage after cleanup:"
          df -h
    
      # 1. Checkout kode Anda
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install dependensi build yang diperlukan
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex gawk gettext \
            git g++ libelf-dev libncurses5-dev \
            libssl-dev python3 python3-venv python3-setuptools python3-distutils \
            python3-pkg-resources python3-pyelftools python3-pip python3-ply libpython3-dev\
            rsync subversion swig time unzip wget \
            zlib1g-dev file
            
      # 3. Update dan install feeds OpenWrt
      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. Salin file .config khusus (DIPERBARUI)
      - name: Load custom .config from user-config directory
        run: |
          # Menyalin file konfigurasi lengkap dari lokasi yang ditentukan ke .config
          # cp user-config/config-zte-e8820v2 .config
          CONFIG_URL="https://raw.githubusercontent.com/paralelunipers/openwrt_8820v2/refs/heads/openwrt-23.05/productconfig/zte_e8820v2_defconfig"
          wget -q --show-progress -O .config $CONFIG_URL

      # 5. Buat .config lengkap dan bersih (Wajib ada untuk mengatasi opsi NEW)
      - name: Generate full and clean .config
        run: |
          make defconfig

      # 6. Mulai proses build (ini akan lama)
      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      - name: Upload firmware
        uses: actions/upload-artifact@main
        with:
          name: OpenWrt_firmware
          path: bin/targets/ramips/mt7621/*
